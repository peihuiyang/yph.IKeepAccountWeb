import{o as t,a,w as s,A as i,g as e,d as r,f as l,t as o,b as d,y as n,r as h}from"./index.cf581458.js";import{_,r as c}from"./uni-app.es.afd85a62.js";const u="RewardedVideo",p="FullScreenVideo",g="Interstitial",f="load",y="close",L="error",C="csj";class b{constructor(t,a={}){this._isLoad=!1,this._isLoading=!1,this._isPlaying=!1,this._lastLoadTime=0,this._lastError=null,this._retryCount=0,void 0!==a.retry?this._retry=a.retry:this._retry=!0,this._loadCallback=null,this._closeCallback=null,this._errorCallback=null;const s=this._ad=t;s.onLoad((t=>{this._isLoading=!1,this._isLoad=!0,this._lastLoadTime=Date.now(),this.onLoad()})),s.onClose((t=>{this._isLoad=!1,this._isPlaying=!1,this.onClose(t)})),s.onVerify&&s.onVerify((t=>{})),s.onError((({code:t,message:a})=>{this._isLoading=!1;const s={code:t,errMsg:a};if(this._retry&&-5008===t)this._loadAd();else{if(this._retry&&this._retryCount<1)return this._retryCount+=1,void this._loadAd();this._lastError=s,this.onError(s)}}))}get isExpired(){return 0!==this._lastLoadTime&&Math.abs(Date.now()-this._lastLoadTime)>18e5}get isLoad(){return this._isLoad}get isLoading(){return this._isLoading}getProvider(){return this._ad.getProvider()}load(t,a){this._loadCallback=t,this._errorCallback=a,this._isPlaying?a&&a():this._isLoading||(this._isLoad?this.onLoad():(this._retryCount=0,this._loadAd()))}show(t,a){if(this._closeCallback=t,this._isLoading||this._isPlaying||!this._isLoad)return;if(null!==this._lastError)return void this.onError(this._lastError);this.getProvider()===C&&this.isExpired?this._retry?this._loadAd():this.onError(this._lastError):(this._isPlaying=!0,this._ad.show(),a&&a())}onLoad(t){null!=this._loadCallback&&this._loadCallback()}onClose(t){null!=this._closeCallback&&this._closeCallback({isEnded:t.isEnded})}onError(t){null!=this._errorCallback&&this._errorCallback(t)}destroy(){this._ad.destroy()}_loadAd(){this._isLoad=!1,this._isLoading=!0,this._lastError=null,this._ad.load()}}class A extends b{constructor(t={}){super(plus.ad.createRewardedVideoAd(t),t)}}class k extends b{constructor(t={}){super(plus.ad.createFullScreenVideoAd(t),t)}}class W extends b{constructor(t={}){super(plus.ad.createInterstitialAd(t),t)}}class v{constructor(t){this._ads={},this._adType=t,this._lastWaterfallIndex=-1}load(t,a,s){t.adpid&&!this.isBusy(t.adpid)&&this.get(t).load(a,s)}show(t,a,s,i,e){const r=this.get(t);r.isLoad?(this._lastWaterfallIndex=-1,r.show((t=>{i&&i(t)}),(()=>{e&&e()}))):r.load((()=>{this._lastWaterfallIndex=-1,a&&a(),r.show((t=>{i&&i(t)}),(()=>{e&&e()}))}),(t=>{s&&s(t)}))}loadWaterfall(t,a,s,i=0){const{adpid:e,urlCallback:r}=t;if(!Array.isArray(e))return;const l={adpid:e[i],urlCallback:r,retry:!1};console.log("ad.loadWaterfall::index="+i),this.load(l,(t=>{this._lastWaterfallIndex=i,a(l)}),(r=>{++i>=e.length?s(r):this.loadWaterfall(t,a,s,i)}))}showWaterfall(t,a,s,i,e,r=0){const{adpid:l,urlCallback:o}=t;if(!Array.isArray(l))return;this._lastWaterfallIndex>-1&&(r=this._lastWaterfallIndex);const d={adpid:l[r],urlCallback:o,retry:!1};console.log("ad.showWaterfall::index="+r),this.show(d,(()=>{a()}),(o=>{++r>=l.length?s(o):this.showWaterfall(t,a,s,i,e,r)}),(t=>{i(t)}),(()=>{e()}))}preloadWaterfall(t,a=0,s=1){if(1===s)return void this.loadWaterfall(t,(t=>{console.log("preloadWaterfall.success::",t)}),(t=>{console.log("loadWaterfall.fail",t)}));const{adpid:i,urlCallback:e}=t;for(let r=0;r<s&&a<i.length;r++){const r={adpid:i[a],urlCallback:e};this.loadWaterfall(r,(t=>{console.log("preloadWaterfall.success::",t)}),(i=>{console.log("loadWaterfall.fail",i),this.preloadWaterfall(t,a,s)})),a++}}isBusy(t){return this._ads[t]&&this._ads[t].isLoading}get(t){const{adpid:a}=t;return this._ads[a]||(this._ads[a]=this._createInstance(t)),this._ads[a]}getProvider(t){return this._ads[t]?this._ads[t].getProvider():null}remove(t){this._ads[t]&&(this._ads[t].destroy(),delete this._ads[t])}_createInstance(t){const a=t.adType||this._adType;delete t.adType;let s=null;return a===u?s=new A(t):a===p?s=new k(t):a===g&&(s=new W(t,!0)),s}}var w=_({name:"AdFullscreenVideo",mixins:[{props:{options:{type:[Object,Array],default:()=>({})},disabled:{type:[Boolean,String],default:!1},adpid:{type:[Number,String,Array],default:""},preload:{type:[Boolean,String],default:!0},loadnext:{type:[Boolean,String],default:!1},urlCallback:{type:Object,default:()=>({})}},data:()=>({loading:!1,errorMessage:null}),created(){this.$watch("adpid",((t,a)=>{this._removeInstance(a),this.preload&&this._loadAd()})),this.$watch("urlCallback",(()=>{this._removeInstance()})),this._adHelper=new v(this.adType),setTimeout((()=>{this.preload&&this._loadAd()}),100)},methods:{load(){if(this.isLoading)return;this._startLoading();const t=this._isWaterfall()?"loadWaterfall":"load";this._adHelper[t](this._getAdOptions(),(()=>{this._onLoad()}),(t=>{this._onLoadFail(t)}))},show(){if(this.isLoading)return;this._startLoading();const t=this._isWaterfall()?"showWaterfall":"show";this._adHelper[t](this._getAdOptions(),(()=>{this._onLoad()}),(t=>{this._onLoadFail(t)}),(t=>{this._dispatchEvent(y,t),this.loadnext&&this.load()}),(()=>{this.loading=!1}))},getProvider(){return Array.isArray(this.adpid)?null:this._adHelper.getProvider(this.adpid)},_loadAd(){this._canCreateAd()&&this.load()},_onclick(){this.disabled||this.show()},_getAdOptions(){return{adpid:this.adpid,urlCallback:this.urlCallback}},_isWaterfall(){return Array.isArray(this.adpid)&&this.adpid.length>0},_canCreateAd(){let t=!1;return(Array.isArray(this.adpid)&&this.adpid.length>0||"string"==typeof this.adpid&&this.adpid.length>0||"number"==typeof this.adpid)&&(t=!0),t},_removeInstance(t){const a=t||this.adpid;Array.isArray(a)?a.forEach((t=>{this._adHelper.remove(t)})):a&&this._adHelper.remove(a)},_startLoading(){this.loading=!0,this.errorMessage=null},_onLoad(){this.loading=!1,this._dispatchEvent(f,{})},_onLoadFail(t){this.loading=!1,this.errorMessage=JSON.stringify(t),this._dispatchEvent(L,t)},_dispatchEvent(t,a){this.$emit(t,{detail:a})}}}],props:{adType:{type:String,default:"FullScreenVideo"}}},[["render",function(r,l,o,d,n,h){const _=e;return t(),a(_,{onClick:r._onclick},{default:s((()=>[i(r.$slots,"default",{options:r.options,loading:r.loading,error:r.errorMessage})])),_:3},8,["onClick"])}]]);var m=_({data:()=>({}),methods:{onadload(t){console.log("广告数据加载成功")},onadclose(t){console.log("onadclose",t)},onaderror(t){console.log("onerror: ",t.detail)}}},[["render",function(i,_,u,p,g,f){const y=n,L=e,C=c(h("ad-fullscreen-video"),w);return t(),a(L,{class:"content"},{default:s((()=>[r(C,{adpid:"126161110103",loadnext:!0,onLoad:f.onadload,onClose:f.onadclose,onError:f.onaderror},{default:s((({loading:i,error:e})=>[r(y,{disabled:i,loading:i},{default:s((()=>[l("显示广告")])),_:2},1032,["disabled","loading"]),e?(t(),a(L,{key:0},{default:s((()=>[l(o(e),1)])),_:2},1024)):d("",!0)])),_:1},8,["onLoad","onClose","onError"])])),_:1})}]]);export{m as default};
