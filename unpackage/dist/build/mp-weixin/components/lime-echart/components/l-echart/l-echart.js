"use strict";var t=require("../../../../common/vendor.js"),e=require("./canvas.js"),s=require("./utils.js");const i={name:"lime-echart",props:{type:{type:String,default:"2d"},customStyle:String,isDisableScroll:Boolean,isClickable:{type:Boolean,default:!0},enableHover:Boolean,beforeDelay:{type:Number,default:30}},data:()=>({use2dCanvas:!0,width:null,height:null,nodeWidth:null,nodeHeight:null,canvasNode:null,config:{},inited:!1,finished:!1,file:"",platform:"",isPc:!1,isDown:!1,isOffscreenCanvas:!1,offscreenWidth:0,offscreenHeight:0}),computed:{canvasId(){return`lime-echart${this._&&this._.uid||this._uid}`},offscreenCanvasId(){return`${this.canvasId}_offscreen`},offscreenStyle(){return`width:${this.offscreenWidth}px;height: ${this.offscreenHeight}px; position: fixed; left: 99999px; background: red`},canvasStyle(){return this.width&&this.height?"width:"+this.width+"px;height:"+this.height+"px":""}},beforeDestroy(){this.clear(),this.dispose()},created(){const{SDKVersion:e,version:i,platform:h,environment:a}=t.index.getSystemInfoSync();this.isPC=/windows/i.test(h),this.use2dCanvas="2d"===this.type&&s.compareVersion(e,"2.9.2")>=0&&!(/ios/i.test(h)&&/7.0.20/.test(i)||/wxwork/i.test(a))&&!this.isPC},mounted(){this.$nextTick((()=>{this.$emit("finished")}))},methods:{setChart(t){this.chart?"function"==typeof t&&this.chart&&t(this.chart):console.warn("组件还未初始化，请先使用 init")},setOption(){this.chart&&this.chart.setOption?this.chart.setOption(...arguments):console.warn("组件还未初始化，请先使用 init")},showLoading(){this.chart&&this.chart.showLoading(...arguments)},hideLoading(){this.chart&&this.chart.hideLoading()},clear(){this.chart&&this.chart.clear()},dispose(){this.chart&&this.chart.dispose()},resize(e){e&&e.width&&e.height?(this.height=e.height,this.width=e.width,this.chart&&this.chart.resize(e)):this.$nextTick((()=>{t.index.createSelectorQuery().in(this).select(".lime-echart").boundingClientRect().exec((t=>{if(t){let{width:e,height:s}=t[0];this.width=e=e||300,this.height=s=s||300,this.chart.resize({width:e,height:s})}}))}))},canvasToTempFilePath(e={}){const{use2dCanvas:s,canvasId:i,canvasNode:h}=this;return new Promise(((a,o)=>{const c=Object.assign({canvasId:i,success:a,fail:o},e);s&&(delete c.canvasId,c.canvas=h),t.index.canvasToTempFilePath(c,this)}))},async init(t,...i){if(arguments&&arguments.length<2)return void console.error("缺少参数：init(echarts, theme?:string, opts?: object, callback: function)");let h,a=null,o={};Array.from(arguments).forEach((t=>{"function"==typeof t&&(h=t),["string"].includes(typeof t)&&(a=t),"object"==typeof t&&(o=t)})),this.beforeDelay&&await s.sleep(this.beforeDelay);let c=await this.getContext();"function"==typeof h?(e.setCanvasCreator(t,c),this.chart=t.init(c.canvas,a,Object.assign({},c,o)),h(this.chart)):console.error("callback 非 function")},getContext(){const{use2dCanvas:i}=this;let h=s.devicePixelRatio;return new Promise(i?s=>{t.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec((t=>{let{node:i,width:a,height:o}=t[0];this.width=a=a||300,this.height=o=o||300;const c=i.getContext("2d"),n=new e.Canvas(c,this,!0,i);this.canvasNode=i,s({canvas:n,width:a,height:o,devicePixelRatio:h,node:i})}))}:i=>{t.index.createSelectorQuery().in(this).select(`#${this.canvasId}`).boundingClientRect().exec((a=>{if(a){let{width:o,height:c}=a[0];this.width=o=o||300,this.height=c=c||300,h=this.isPC?s.devicePixelRatio:1,this.rect=a[0],this.nodeWidth=o*h,this.nodeHeight=c*h;const n=t.index.createCanvasContext(this.canvasId,this),r=new e.Canvas(n,this,!1);i({canvas:r,width:o,height:c,devicePixelRatio:h})}}))})},getRelative(t){return{x:t.pageX-this.rect.left,y:t.pageY-this.rect.top,wheelDelta:t.wheelDelta}},getTouch(t){return t.touches&&t.touches[0]&&t.touches[0].x?t.touches[0]:this.getRelative(t)},touchStart(t){if(this.isDown=!0,this.chart&&((t.touches.length>0||t.touches[0])&&"mousemove"!=t.type||"mousedown"==t.type)){const i=this.getTouch(t);this.startX=i.x,this.startY=i.y,this.startT=new Date;const h=this.chart.getZr().handler;e.dispatch.call(h,"mousedown",i),e.dispatch.call(h,"mousemove",i),h.processGesture(s.wrapTouch(t),"start"),clearTimeout(this.endTimer)}},touchMove(t){if(this.isPc&&this.enableHover&&!this.isDown&&(this.isDown=!0),this.chart&&((t.touches.length>0||t.touches[0])&&"mousemove"!=t.type||"mousemove"==t.type&&this.isDown)){const i=this.chart.getZr().handler;e.dispatch.call(i,"mousemove",this.getTouch(t)),i.processGesture(s.wrapTouch(t),"change")}},touchEnd(t){if(this.isDown=!1,this.chart){const{x:i}=t.changedTouches&&t.changedTouches[0]||{},h=(i?t.changedTouches[0]:this.getRelative(t))||{},a=this.chart.getZr().handler,o=Math.abs(h.x-this.startX)<10&&new Date-this.startT<200;e.dispatch.call(a,"mouseup",h),a.processGesture(s.wrapTouch(t),"end"),o?e.dispatch.call(a,"click",h):this.endTimer=setTimeout((()=>{e.dispatch.call(a,"mousemove",{x:999999999,y:999999999}),e.dispatch.call(a,"mouseup",{x:999999999,y:999999999})}),50)}}}};var h=t._export_sfc(i,[["render",function(e,s,i,h,a,o){return t.e({a:o.canvasId},o.canvasId?t.e({b:a.use2dCanvas},a.use2dCanvas?{c:o.canvasId,d:t.s(o.canvasStyle),e:i.isDisableScroll,f:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),g:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),h:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))}:a.isPc?{j:t.s(o.canvasStyle),k:o.canvasId,l:o.canvasId,m:i.isDisableScroll,n:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),o:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),p:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))}:{q:a.nodeWidth,r:a.nodeHeight,s:t.s(o.canvasStyle),t:o.canvasId,v:o.canvasId,w:i.isDisableScroll,x:t.o(((...t)=>o.touchStart&&o.touchStart(...t))),y:t.o(((...t)=>o.touchMove&&o.touchMove(...t))),z:t.o(((...t)=>o.touchEnd&&o.touchEnd(...t)))},{i:a.isPc,A:a.isOffscreenCanvas},a.isOffscreenCanvas?{B:t.s(o.offscreenStyle),C:o.offscreenCanvasId}:{},{D:t.s(i.customStyle)}):{})}],["__scopeId","data-v-2cfe2c83"]]);wx.createComponent(h);
