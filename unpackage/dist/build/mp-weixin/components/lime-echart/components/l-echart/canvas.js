"use strict";var t=require("../../../../common/vendor.js");const e={},s=/([\d\.]+)px/;class i{constructor(){this.__events={}}on(t,e){if(!t||!e)return;const s=this.__events[t]||[];s.push(e),this.__events[t]=s}emit(t,e){if(t.constructor===Object&&(t=(e=t)&&e.type),!t)return;const s=this.__events[t];s&&s.length&&s.forEach((t=>{t.call(this,e)}))}off(t,e){const s=this.__events,i=s[t];if(i&&i.length)if(e)for(let n=0,r=i.length;n<r;n++)i[n]===e&&(i.splice(n,1),n--);else delete s[t]}}class n{constructor(){this.currentSrc=null,this.naturalHeight=0,this.naturalWidth=0,this.width=0,this.height=0,this.tagName="IMG"}set src(e){this.currentSrc=e,t.index.getImageInfo({src:e,success:t=>{this.naturalWidth=this.width=t.width,this.naturalHeight=this.height=t.height,this.onload()},fail:()=>{this.onerror()}})}get src(){return this.currentSrc}}class r{constructor(t,e,s){this.tagName="canvas",this.com=e,this.canvasId=s,this.ctx=t}set width(t){this.com.offscreenWidth=t}set height(t){this.com.offscreenHeight=t}get width(){return this.com.offscreenWidth||0}get height(){return this.com.offscreenHeight||0}getContext(t){return this.ctx}getImageData(){return new Promise(((e,s)=>{this.com.$nextTick((()=>{t.index.canvasGetImageData({x:0,y:0,width:this.com.offscreenWidth,height:this.com.offscreenHeight,canvasId:this.canvasId,success:t=>{e(t)},fail:t=>{s(t)}},this.com)}))}))}}exports.Canvas=class{constructor(t,s,n,r={}){e[s.canvasId]={ctx:t},this.canvasId=s.canvasId,this.chart=null,this.isNew=n,this.tagName="canvas",this.canvasNode=r,this.com=s,n||this._initStyle(t),this._initEvent(),this._ee=new i}getContext(t){if("2d"===t)return this.ctx}setChart(t){this.chart=t}createOffscreenCanvas(e){if(!this.children){this.com.isOffscreenCanvas=!0,this.com.offscreenWidth=e.width||300,this.com.offscreenHeight=e.height||300;const s=this.com,i=this.com.offscreenCanvasId,n=t.index.createCanvasContext(i,this.com);this._initStyle(n),this.children=new r(n,s,i)}return this.children}appendChild(t){console.log("child",t)}dispatchEvent(t,e){return"object"==typeof t?this._ee.emit(t.type,t):this._ee.emit(t,e),!0}attachEvent(){}detachEvent(){}addEventListener(t,e){this._ee.on(t,e)}removeEventListener(t,e){this._ee.off(t,e)}_initCanvas(t,e){t.util.getContext=function(){return e},t.util.$override("measureText",(function(t,s){return e.font=s||"12px sans-serif",e.measureText(t,s)}))}_initStyle(t,e){if(["fillStyle","strokeStyle","fontSize","globalAlpha","opacity","textAlign","textBaseline","shadow","lineWidth","lineCap","lineJoin","lineDash","miterLimit","font"].forEach((e=>{Object.defineProperty(t,e,{set:i=>{if("font"===e&&s.test(i)){const e=s.exec(i);t.setFontSize(e[1])}else"opacity"!==e?("fillStyle"!==e&&"strokeStyle"!==e||"none"!==i&&null!==i)&&t["set"+e.charAt(0).toUpperCase()+e.slice(1)](i):t.setGlobalAlpha(i)}})})),this.isNew||e||(t.uniDrawImage=t.drawImage,t.drawImage=(...e)=>{e[0]=e[0].src,t.uniDrawImage(...e)}),t.createRadialGradient||(t.createRadialGradient=function(){return t.createCircularGradient(...[...arguments].slice(-3))}),t.strokeText||(t.strokeText=(...e)=>{t.fillText(...e)}),!t.measureText){const e=t=>{let e=0;for(let s=0;s<t.length;s++)t.charCodeAt(s)>0&&t.charCodeAt(s)<128?e++:e+=2;return e};t.measureText=(t,s)=>{let i=12;return s&&(i=parseInt(s.match(/([\d\.]+)px/)[1])),i/=2,{width:e(t)*i}}}}_initEvent(t){this.event={};[{wxName:"touchStart",ecName:"mousedown"},{wxName:"touchMove",ecName:"mousemove"},{wxName:"touchEnd",ecName:"mouseup"},{wxName:"touchEnd",ecName:"click"}].forEach((t=>{this.event[t.wxName]=e=>{const s=e.touches[0];this.chart.getZr().handler.dispatch(t.ecName,{zrX:"tap"===t.wxName?s.clientX:s.x,zrY:"tap"===t.wxName?s.clientY:s.y})}}))}set width(t){this.canvasNode.width=t}set height(t){this.canvasNode.height=t}get width(){return this.canvasNode.width||0}get height(){return this.canvasNode.height||0}get ctx(){return e[this.canvasId].ctx||null}set chart(t){e[this.canvasId].chart=t}get chart(){return e[this.canvasId].chart||null}},exports.dispatch=function(t,{x:e,y:s,wheelDelta:i}){this.dispatch(t,{zrX:e,zrY:s,zrDelta:i,preventDefault:()=>{},stopPropagation:()=>{}})},exports.setCanvasCreator=function(t,{canvas:e,node:s}){t.registerPreprocessor((t=>{t&&t.series&&(t.series.length>0?t.series.forEach((t=>{t.progressive=0})):"object"==typeof t.series&&(t.series.progressive=0))})),t.setPlatformAPI&&t.setPlatformAPI({loadImage:e.setChart?function(t,e,i){let r=null;return s&&s.createImage?(r=s.createImage(),r.onload=e.bind(r),r.onerror=i.bind(r),r.src=t,r):(r=new n,r.onload=e.bind(r),r.onerror=i.bind(r),r.src=t,r)}:null,createCanvas:()=>e})};
